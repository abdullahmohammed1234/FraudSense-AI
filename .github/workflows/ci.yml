# =============================================================================
# FraudSense AI - CI/CD Pipeline
# =============================================================================
# GitHub Actions workflow for continuous integration and deployment

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ---------------------------------------------------------------------------
  # Lint and Code Quality
  # ---------------------------------------------------------------------------
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          pip install flake8 black mypy isort
      
      - name: Run flake8
        run: |
          flake8 backend/ --max-line-length=120 --ignore=E501,W503
      
      - name: Run black check
        run: |
          black --check backend/
      
      - name: Run isort check
        run: |
          isort --check-only backend/
      
      - name: Run mypy type check
        run: |
          mypy backend/ --ignore-missing-imports --no-error-summary

  # ---------------------------------------------------------------------------
  # Unit Tests
  # ---------------------------------------------------------------------------
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Create model files for testing
        run: |
          python -c "import pickle; import numpy as np; from sklearn.ensemble import RandomForestClassifier; clf = RandomForestClassifier(n_estimators=10, random_state=42); clf.fit(np.random.rand(100, 30), np.random.randint(0, 2, 100)); pickle.dump(clf, open('backend/model.pkl', 'wb'))"
          echo '{"model_type": "RandomForest", "training_date": "2024-01-01", "metrics": {"accuracy": 0.95}, "threshold": 0.5, "dataset_size": 100, "feature_count": 30, "version": "1.0.0", "health_status": "healthy"}' > backend/model_metadata.json
      
      - name: Run pytest
        run: |
          pytest backend/ -v --cov=RiskPlatform --cov-report=xml --cov-report=term
        continue-on-error: true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml

  # ---------------------------------------------------------------------------
  # Build Docker Image
  # ---------------------------------------------------------------------------
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile
          push: false
          tags: fraudsense-ai:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Verify image builds
        run: |
          docker images | grep fraudsense-ai

  # ---------------------------------------------------------------------------
  # API Schema Validation
  # ---------------------------------------------------------------------------
  api-validation:
    name: API Schema Validation
    runs-on: ubuntu-latest
    needs: [build-docker]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install httpx openapi-schema-validator
      
      - name: Create model files
        run: |
          python -c "import pickle; import numpy as np; from sklearn.ensemble import RandomForestClassifier; clf = RandomForestClassifier(n_estimators=10, random_state=42); clf.fit(np.random.rand(100, 30), np.random.randint(0, 2, 100)); pickle.dump(clf, open('backend/model.pkl', 'wb'))"
          echo '{"model_type": "RandomForest", "training_date": "2024-01-01", "metrics": {"accuracy": 0.95}, "threshold": 0.5, "dataset_size": 100, "feature_count": 30, "version": "1.0.0", "health_status": "healthy"}' > backend/model_metadata.json
      
      - name: Start API server in background
        run: |
          cd backend && python -m uvicorn main:app --host 127.0.0.1 --port 8765 &
          sleep 10
      
      - name: Validate API Schema
        run: |
          pip install httpx
          python -c "import httpx; r = httpx.get('http://127.0.0.1:8765/health'); print(f'Health: {r.status_code}'); assert r.status_code == 200"
          python -c "import httpx; r = httpx.get('http://127.0.0.1:8765/metrics'); print(f'Metrics: {r.status_code}')"
          python -c "import httpx; r = httpx.get('http://127.0.0.1:8765/model-health'); print(f'ModelHealth: {r.status_code}')"
          python -c "import httpx; r = httpx.post('http://127.0.0.1:8765/simulate-threshold', json={'threshold': 0.5}); print(f'SimThreshold: {r.status_code}')"
      
      - name: Stop API server
        run: |
          pkill -f "uvicorn main:app"

  # ---------------------------------------------------------------------------
  # Security Scan
  # ---------------------------------------------------------------------------
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install security tools
        run: |
          pip install bandit safety
      
      - name: Run bandit security scan
        run: |
          bandit -r backend/ -f json -o bandit-report.json || true
      
      - name: Run safety check
        run: |
          pip install -r requirements.txt || true
          safety check --json > safety-report.json || true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # ---------------------------------------------------------------------------
  # Deploy (on main branch)
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [api-validation, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/fraudsense-ai:latest
            ${{ secrets.DOCKER_USERNAME }}/fraudsense-ai:${{ github.sha }}
      
      - name: Deploy notification
        run: |
          echo "Deployment triggered for commit ${{ github.sha }}"
